<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TvSeries Details</title>
    <link rel="icon" type="image/png" href="../static/logo.png">
    <link rel="stylesheet" href="/static/css/landing.css">
</head>
<style>
    .cast-list {
        border: 1px solid #ccc;
        display: flex;
        overflow-x: auto;
        margin: 20px;
        /* Remove this as it's overridden by display: flex */

        /* Hide scrollbar for IE, Edge, and Firefox, Chrome, Safari, and Opera
        -ms-overflow-style: none; 
        scrollbar-width: none; 
        &::-webkit-scrollbar {
            display: none;
        }
        */
    }

    .episodes-list {
        border: 1px solid #ccc;
        display: flex;
        overflow-x: auto;
        margin: 20px;
        /* Hide initially */

        /* Hide scrollbar for IE, Edge, and Firefox, Chrome, Safari, and Opera
    -ms-overflow-style: none; 
    scrollbar-width: none; 
    &::-webkit-scrollbar {
        display: none;
    }
    */
    }



    .cast-item {
        margin-right: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
        margin-left: 25px;

        border: 1px solid #ccc;
        padding: 10px;
        margin-right: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        text-align: center;
        min-width: 250px;
        max-width: 250px;
        background-color: #717171;
        transition: transform 0.3s ease;
    }

    .episode-item {
        margin-right: 10px;
        margin-top: 20px;
        margin-bottom: 20px;
        margin-left: 25px;

        border: 1px solid #ccc;
        padding: 10px;
        margin-right: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        text-align: center;
        min-width: 250px;
        max-width: 250px;
        background-color: #717171;
        transition: transform 0.3s ease;
    }

    .hidden {
        display: none !important;
        /* Hide when this class is applied */
    }

    .cast-item:hover {
        transform: scale(1.05);
        cursor: pointer;
    }

    .episode-item:hover {
        transform: scale(1.05);
        cursor: pointer;
    }

    .movieInfo {
        margin-left: 20px;
    }

    .movie-details-flex-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 20px;
    }

    .movie-info-section {
        flex: 3;
        /* Adjust as needed for the desired width */
        padding-right: 20px;
        /* Spacing between the sections */
    }

    .movie-poster-section {
        flex: 1;
        padding-right: 40px;
        padding-top: 20px;
        padding-bottom: 20px;
    }


    @media (max-width: 768px) {
        .movie-details-flex-container {
            flex-direction: column;
        }

        .movie-info-section,
        .movie-poster-section {
            max-width: 100%;
            /* Full width for smaller screens */
            /* Adjust to stack the sections vertically */
        }
    }

    .cast-item img {
        margin-top: 20px;
    }

    .episode-item img {
        margin-top: 20px;
    }
</style>

<body>

    <header class="site-header">
        <img src="../static/logo.png" alt="NTUAFlix Logo">
    </header>
    <div id="movieDetailsContainer" class="movieInfo">
        <!-- Movie details will be displayed here -->
    </div>
    <div id="tvshowepisodes" class="movieInfo">
    </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const serieId = urlParams.get('seriesId');

            // Function to fetch movie details
            function fetchMovieDetails(id) {
                // Replace with the actual API endpoint or data fetching logic
                fetch(`http://localhost:7117/ntuaflix_api/title/${id}`)
                    .then(response => response.json())
                    .then(data => displayMovieDetails(data[0]))
                    .catch(error => console.error('Error fetching movie details:', error));
            }

            function fetchPersonDetails(id) {

                return fetch(`http://localhost:7117/ntuaflix_api/person/${id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        return data[0];
                    })
                    .catch(error => {
                        console.error('Error fetching movie details:', error);
                        throw error;
                    });
            }




            async function fetchEpisodesDetails(id) {
                try {
                    const response = await fetch(`http://localhost:7117/ntuaflix_api/title/${id}`);

                    const episodeData = await response.json();

                    return episodeData;
                } catch (error) {
                    console.error('Error fetching student info:', error);
                    return null;
                }
            }


            function fetchCharacterDetails(nameID, titleID) {
                return fetch(`http://localhost:7117/ntuaflix_api/character/${nameID}/${titleID}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Error fetching character details:', error);
                        // Return a default object to avoid undefined
                        return { characters: '' };
                    });
            }

            function fetchCrewDetails(titleID) {
                return fetch(`http://localhost:7117/ntuaflix_api/crew/${titleID}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Error fetching crew details:', error);
                        // Return a default object to avoid undefined
                        return { director: [], writer: [] };
                    });
            }

            function fetchEpisodeDetails(titleID) {
                return fetch(`http://localhost:7117/ntuaflix_api/episodes/${titleID}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Error fetching crew details:', error);
                    });
            }

            function groupEpisodesBySeason(episodeData) {
                return episodeData.reduce((acc, episode) => {
                    (acc[episode.seasonN] = acc[episode.seasonN] || []).push(episode);
                    return acc;
                }, {});
            }

            function createEpisodeDiv(episode, details) {

                const div = document.createElement('div');

                div.setAttribute('id', episode.tconst);

                div.classList.add('episode-item');
                let episodeContent
                if (episode.episodeN === "\\N") {
                    episodeContent = `<h3>${details.originalTitle}</h3>`;

                } else {
                    episodeContent = `<h2>Episode ${episode.episodeN}: </h2><h3>${details.originalTitle}</h3>`;
                }
                // Add the episode poster if available
                if (details.titlePoster && details.titlePoster !== '\\N') {


                    episodeContent += `<img src="${details.titlePoster.replace('{width_variable}', 'w200')}" alt="${details.originalTitle}">`;
                }

                // Add genres
                if (details.genres && details.genres.length > 0) {
                    episodeContent += `<p>Genres: ${details.genres.map(genre => genre.genreTitle).join(', ')}</p>`;
                }

                // Add rating information
                if (details.rating && details.rating.avRating !== "\\N") {
                    episodeContent += `<p>Rating: ${details.rating.avRating} (${details.rating.nVotes} votes)</p>`;
                }


                div.innerHTML = episodeContent;


                // Attach event listener
                div.addEventListener('click', (event) => {

                    redirectToMoviePage(event.currentTarget.getAttribute('id'));
                });

                return div;
            }


            function calculateAge(birthYear, deathYear) {
                const currentYear = new Date().getFullYear();
                let age;

                if (deathYear && deathYear !== '\\N') {
                    age = deathYear - birthYear;
                    return `Died at age ${age}`;
                } else {
                    age = currentYear - birthYear;
                    return `Age: ${age}`;
                }
            }


            function redirectToPersonPage(personId) {
                window.location.href = `http://localhost:8228/personpage?personId=${personId}`;
            }

            function redirectToMoviePage(movieId) {
                window.location.href = `http://localhost:8228/moviepage?movieId=${movieId}`;
            }
            async function displayMovieDetails(movieData) {
                console.log(movieData);
                const container = document.getElementById('movieDetailsContainer');
                container.innerHTML = ''; // Clear existing content

                // Start building HTML content with the basic movie details
                let htmlContent = `
                        <div class="movie-details-flex-container">
                        <div class="movie-info-section">
                        <h1>${movieData.originalTitle}</h1>
                        <p>Year: ${movieData.startYear}</p>`
                if (movieData.rating && movieData.rating.avRating !== "\\N") {
                    htmlContent += `<p>Rating: ${movieData.rating.avRating} (${movieData.rating.nVotes})</p>`;

                }


                // Add genres if available
                if (movieData.genres && movieData.genres.length > 0) {
                    htmlContent += `<p>Genres: ${movieData.genres.map(genre => genre.genreTitle).join(', ')}</p>`;
                }





                // Add titleAkas if available
                let flag1 = true;
                if (movieData.titleAkas && movieData.titleAkas.length > 0) {
                    movieData.titleAkas.slice(0, 20).forEach(aka => {
                        if (aka.akaTitle === movieData.originalTitle) return; //na min valume ta idia titles.
                        if (flag1) {

                            htmlContent += '<div><h3>Alternate Titles:</h3><ul>';
                            flag1 = false;
                        }
                        htmlContent += `<li>${aka.akaTitle} (${aka.regionAbbrev !== '\\N' ? aka.regionAbbrev : 'N/A'})</li>`;
                    });
                    htmlContent += '</ul></div>';
                }

                htmlContent += `</div>`;


                // Add the movie poster if available
                if (movieData.titlePoster) {
                    htmlContent += `<div class="movie-poster-section">
            ${movieData.titlePoster ? `<img src="${movieData.titlePoster.replace('{width_variable}', 'w400')}" alt="${movieData.originalTitle}">` : ''}
                </div>`;
                }
                htmlContent += `</div>`;
                const MovieInfoContainer = document.createElement('div');
                MovieInfoContainer.innerHTML = htmlContent;
                container.appendChild(MovieInfoContainer);
                // Function to create and return a div for a cast or crew member
                function createPersonDiv(personInfo, principal, characterInfo = null) {
                    const div = document.createElement('div');
                    div.classList.add('cast-item');
                    div.setAttribute('id', principal.nameID);

                    // Check if image URL is available and not null
                    if (personInfo.img_url_asset && personInfo.img_url_asset !== '\\N') {
                        div.innerHTML += `<img src="${personInfo.img_url_asset.replace('{width_variable}', 'w200')}" alt="${personInfo.primaryName}">`;
                    }

                    div.innerHTML += `<h3>${personInfo.primaryName}</h3>`;
                    characterInfo = characterInfo[0]

                    if (characterInfo && characterInfo.characters && (characterInfo.category === 'actor' || characterInfo.category === 'actress')) {
                        const characterName = characterInfo.characters.replace(/[\[\]"]+/g, ''); // Remove brackets and quotes
                        div.innerHTML += `<p>as ${characterName}</p>`;
                    }

                    // Add profession, birth year, and death year, if available
                    if (personInfo.primaryProfession && personInfo.primaryProfession !== '\\N' && ((characterInfo.category !== 'actor' && characterInfo.category !== 'actress'))) {

                        div.innerHTML += `<p>Profession: ${characterInfo.category}</p>`;
                    }
                    if (personInfo.birthYear && personInfo.birthYear !== '\\N') {
                        let ageString = calculateAge(personInfo.birthYear, personInfo.deathYear);
                        div.innerHTML += `<p>Birth Year: ${personInfo.birthYear}</p>`;
                        if (ageString[0] === 'A') {
                            div.innerHTML += `(${ageString})`;
                        }
                        div.innerHTML += `</p>`;
                    }
                    if (personInfo.deathYear && personInfo.deathYear !== '\\N') {
                        let ageString = calculateAge(personInfo.birthYear, personInfo.deathYear);
                        div.innerHTML += `<p>Death Year: ${personInfo.deathYear}</p> <p> (${ageString})</p>`;
                    }

                    // Attach event listener
                    div.addEventListener('click', (event) => {

                        redirectToPersonPage(event.currentTarget.getAttribute('id'));
                    });

                    return div;
                }

                function createCrewDiv(crewMember, roles) {
                    const div = document.createElement('div');
                    div.classList.add('cast-item');
                    div.setAttribute('id', crewMember.nconst);


                    // Check if image URL is available and not null
                    if (crewMember.img_url_asset && crewMember.img_url_asset !== '\\N') {
                        div.innerHTML += `<img src="${crewMember.img_url_asset.replace('{width_variable}', 'w200')}" alt="${crewMember.primaryName}">`;
                    }

                    div.innerHTML += `<h3>${crewMember.primaryName}</h3>`;
                    div.innerHTML += `<p>Role: ${roles}</p>`;

                    // Add birth year and age, if available
                    if (crewMember.birthYear && crewMember.birthYear !== '\\N') {
                        let ageString = calculateAge(crewMember.birthYear, crewMember.deathYear);
                        div.innerHTML += `<p>Birth Year: ${crewMember.birthYear}</p>`;
                        div.innerHTML += ageString[0] === 'A' ? `(${ageString})` : '';
                    }

                    // Add death year, if available
                    if (crewMember.deathYear && crewMember.deathYear !== '\\N') {
                        let ageString = calculateAge(crewMember.birthYear, crewMember.deathYear);
                        div.innerHTML += `<p>Death Year: ${crewMember.deathYear} (${ageString})</p>`;
                    }

                    // Attach event listener
                    div.addEventListener('click', (event) => {

                        redirectToPersonPage(event.currentTarget.getAttribute('id'));
                    });

                    return div;
                }

                function combineCrewData(directors, writers) {
                    let combinedCrew = {};

                    if (!directors) directors = [];
                    directors.forEach(director => {
                        combinedCrew[director.nconst] = { ...director, roles: ['Director'] };
                    });

                    if (!writers) writers = [];
                    writers.forEach(writer => {
                        if (combinedCrew[writer.nconst]) {
                            combinedCrew[writer.nconst].roles.push('Writer');
                        } else {
                            combinedCrew[writer.nconst] = { ...writer, roles: ['Writer'] };
                        }
                    });

                    return Object.values(combinedCrew);
                }



                // Add cast if available
                let flag = true;
                if (movieData.principals && movieData.principals.length > 0) {

                    for (const principal of movieData.principals) {
                        if (principal.category === 'actor' || principal.category === 'actress') {
                            if (flag) {

                                const castContainer = document.createElement('div');
                                castContainer.classList.add('cast-container');
                                castContainer.innerHTML = '<h1>Cast:</h1><div class="cast-list"></div>';
                                container.appendChild(castContainer);

                                castListDiv = castContainer.querySelector('.cast-list');
                                flag = false;
                            }
                            const personInfo = await fetchPersonDetails(principal.nameID);
                            const characterInfo = await fetchCharacterDetails(principal.nameID, movieData.titleID);
                            const personDiv = createPersonDiv(personInfo, principal, characterInfo);
                            castListDiv.appendChild(personDiv);
                        }
                    }
                }

                // Add principals if available
                flag = true;
                if (movieData.principals && movieData.principals.length > 0) {

                    for (const principal of movieData.principals) {
                        if (principal.category !== 'actor' && principal.category !== 'actress' && principal.category !== 'writer' && principal.category !== 'director') {
                            if (flag) {

                                const castContainer = document.createElement('div');
                                castContainer.classList.add('cast-container');
                                castContainer.innerHTML = '<h1>Principals:</h1><div class="cast-list"></div>';
                                container.appendChild(castContainer);

                                castListDiv = castContainer.querySelector('.cast-list');
                                flag = false;
                            }
                            const personInfo = await fetchPersonDetails(principal.nameID);
                            const characterInfo = await fetchCharacterDetails(principal.nameID, movieData.titleID);
                            if (characterInfo[0].category === 'writer' || characterInfo[0].category === 'director') continue;//tha tous valume sto crew
                            const personDiv = createPersonDiv(personInfo, principal, characterInfo);
                            castListDiv.appendChild(personDiv);
                        }
                    }
                }

                // Add crew if available
                let crewData = await fetchCrewDetails(movieData.titleID);
                crewData = crewData[0].result;


                if (crewData && ((crewData.director && crewData.director.length > 0) || (crewData.writer && crewData.writer.length > 0))) {
                    const combinedCrew = combineCrewData(crewData.director, crewData.writer);


                    const crewContainer = document.createElement('div');
                    crewContainer.classList.add('cast-container');
                    crewContainer.innerHTML = '<h1>Crew:</h1><div class="cast-list"></div>';
                    container.appendChild(crewContainer);

                    const crewListDiv = crewContainer.querySelector('.cast-list');


                    for (const crewMember of combinedCrew) {
                        const crewDiv = createCrewDiv(crewMember, crewMember.roles.join(' & '));
                        crewListDiv.appendChild(crewDiv);
                    }
                }

                // Display episodes
                let episodeData = await fetchEpisodeDetails(movieData.titleID);
                const episodesBySeason = groupEpisodesBySeason(episodeData);

                const seasonsContainer = document.getElementById('tvshowepisodes');
                let epflag = true;
                for (const [season, episodes] of Object.entries(episodesBySeason)) {
                    let episodesListDiv
                    let seasonContainer
                    //if (season === '\\N' || episodes === '\\N'){
                    seasonContainer = document.createElement('div');
                    seasonContainer.classList.add('cast-container');
                    if (season === "\\N") {
                        seasonContainer.innerHTML = `<h1>Special Episodes:</h1><div class="episodes-list hidden"></div>`;

                    } else {
                        seasonContainer.innerHTML = `<h1>Season ${season}:</h1><div class="episodes-list hidden"></div>`;
                    }
                    seasonsContainer.appendChild(seasonContainer);
                    episodesListDiv = seasonContainer.querySelector('.episodes-list');
                    episodesListDiv.classList.add('hidden'); // Start with episodes hidden

                    //}
                    try {
                        for (const episode of episodes) {
                            const episodeDetails = await fetchEpisodesDetails(episode.tconst);


                            if (episodeDetails && episodeDetails.length > 0) {
                                const episodeDiv = createEpisodeDiv(episode, episodeDetails[0]);
                                episodesListDiv.appendChild(episodeDiv);
                            } else {
                                console.error('Episode details not found for:', episode.tconst);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching episode details:', error);
                    }



                    // Add expand/collapse functionality to the season container

                    const expandBtn = document.createElement('button');
                    expandBtn.textContent = 'Expand';
                    expandBtn.addEventListener('click', function () {
                        const isHidden = episodesListDiv.classList.toggle('hidden');
                        expandBtn.textContent = isHidden ? 'Expand' : 'Contract';
                    });


                    seasonContainer.insertBefore(expandBtn, episodesListDiv);
                }
            }

            // Fetch and display the details for the provided movie ID
            if (serieId) {
                fetchMovieDetails(serieId);
            } else {
                console.log("No movie ID provided.");
            }
        });




    </script>
</body>

</html>